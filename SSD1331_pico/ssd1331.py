#code reference from the following sources
#https://github.com/danjperron/pico_mpu6050_ssd1331/blob/main/ssd1331.py
#https://gist.github.com/TheRayTracer/dd12c498e3ecb9b8b47f


import ustruct
import utime
from micropython import const

_DRAWLINE = const(0x21)
_DRAWRECT = const(0x22)
_NO_SCROLL = const(0x2e)
_FILL = const(0x26)
_PHASEPERIOD = const(0x12)
_SETCOLUMN = const(0x15)
_SETROW = const(0x75)
_CONTRASTA = const(0x81)
_CONTRASTB = const(0x82)
_CONTRASTC = const(0x83)
_MASTERCURRENT = const(0x87)
_SETREMAP = const(0xA0)
_STARTLINE = const(0xA1)
_DISPLAYOFFSET = const(0xA2)
_NORMALDISPLAY = const(0xA4)
_DISPLAYALLON = const(0xA5)
_DISPLAYALLOFF = const(0xA6)
_INVERTDISPLAY = const(0xA7)
_SETMULTIPLEX = const(0xA8)
_SETMASTER = const(0xAD)
_DISPLAYOFF = const(0xAE)
_DISPLAYON = const(0xAF)
_POWERMODE = const(0xB0)
_PRECHARGE = const(0xB1)
_CLOCKDIV = const(0xB3)
_PRECHARGEA = const(0x8A)
_PRECHARGEB = const(0x8B)
_PRECHARGEC = const(0x8C)
_PRECHARGELEVEL = const(0xBB)
_VCOMH = const(0xBE)
_LOCK = const(0xfd)

ascii = [
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ],
    [ 0x00, 0x00, 0x00, 0x00, 0x00 ], # sp
    [ 0x00, 0x00, 0x2f, 0x00, 0x00 ], # !
    [ 0x00, 0x07, 0x00, 0x07, 0x00 ], # "
    [ 0x14, 0x7f, 0x14, 0x7f, 0x14 ], # #
    [ 0x24, 0x2a, 0x7f, 0x2a, 0x12 ], # $
    [ 0x62, 0x64, 0x08, 0x13, 0x23 ], # %
    [ 0x36, 0x49, 0x55, 0x22, 0x50 ], # &
    [ 0x00, 0x05, 0x03, 0x00, 0x00 ], # ' 
    [ 0x00, 0x1c, 0x22, 0x41, 0x00 ], # (
    [ 0x00, 0x41, 0x22, 0x1c, 0x00 ], # )
    [ 0x14, 0x08, 0x3E, 0x08, 0x14 ], # *
    [ 0x08, 0x08, 0x3E, 0x08, 0x08 ], # +
    [ 0x00, 0x00, 0xA0, 0x60, 0x00 ], # , 
    [ 0x08, 0x08, 0x08, 0x08, 0x08 ], # - 
    [ 0x00, 0x60, 0x60, 0x00, 0x00 ], # . 
    [ 0x20, 0x10, 0x08, 0x04, 0x02 ], # /
    [ 0x3E, 0x51, 0x49, 0x45, 0x3E ], # 0
    [ 0x00, 0x42, 0x7F, 0x40, 0x00 ], # 1
    [ 0x42, 0x61, 0x51, 0x49, 0x46 ], # 2
    [ 0x21, 0x41, 0x45, 0x4B, 0x31 ], # 3
    [ 0x18, 0x14, 0x12, 0x7F, 0x10 ], # 4
    [ 0x27, 0x45, 0x45, 0x45, 0x39 ], # 5
    [ 0x3C, 0x4A, 0x49, 0x49, 0x30 ], # 6
    [ 0x01, 0x71, 0x09, 0x05, 0x03 ], # 7
    [ 0x36, 0x49, 0x49, 0x49, 0x36 ], # 8
    [ 0x06, 0x49, 0x49, 0x29, 0x1E ], # 9
    [ 0x00, 0x36, 0x36, 0x00, 0x00 ], # :
    [ 0x00, 0x56, 0x36, 0x00, 0x00 ], # ;
    [ 0x08, 0x14, 0x22, 0x41, 0x00 ], # <
    [ 0x14, 0x14, 0x14, 0x14, 0x14 ], # =
    [ 0x00, 0x41, 0x22, 0x14, 0x08 ], # >
    [ 0x02, 0x01, 0x51, 0x09, 0x06 ], # ?
    [ 0x32, 0x49, 0x59, 0x51, 0x3E ], # @
    [ 0x7C, 0x12, 0x11, 0x12, 0x7C ], # A
    [ 0x7F, 0x49, 0x49, 0x49, 0x36 ], # B
    [ 0x3E, 0x41, 0x41, 0x41, 0x22 ], # C
    [ 0x7F, 0x41, 0x41, 0x22, 0x1C ], # D
    [ 0x7F, 0x49, 0x49, 0x49, 0x41 ], # E
    [ 0x7F, 0x09, 0x09, 0x09, 0x01 ], # F
    [ 0x3E, 0x41, 0x49, 0x49, 0x7A ], # G
    [ 0x7F, 0x08, 0x08, 0x08, 0x7F ], # H
    [ 0x00, 0x41, 0x7F, 0x41, 0x00 ], # I
    [ 0x20, 0x40, 0x41, 0x3F, 0x01 ], # J
    [ 0x7F, 0x08, 0x14, 0x22, 0x41 ], # K
    [ 0x7F, 0x40, 0x40, 0x40, 0x40 ], # L
    [ 0x7F, 0x02, 0x0C, 0x02, 0x7F ], # M
    [ 0x7F, 0x04, 0x08, 0x10, 0x7F ], # N
    [ 0x3E, 0x41, 0x41, 0x41, 0x3E ], # O
    [ 0x7F, 0x09, 0x09, 0x09, 0x06 ], # P
    [ 0x3E, 0x41, 0x51, 0x21, 0x5E ], # Q
    [ 0x7F, 0x09, 0x19, 0x29, 0x46 ], # R
    [ 0x46, 0x49, 0x49, 0x49, 0x31 ], # S
    [ 0x01, 0x01, 0x7F, 0x01, 0x01 ], # T
    [ 0x3F, 0x40, 0x40, 0x40, 0x3F ], # U
    [ 0x1F, 0x20, 0x40, 0x20, 0x1F ], # V
    [ 0x3F, 0x40, 0x38, 0x40, 0x3F ], # W
    [ 0x63, 0x14, 0x08, 0x14, 0x63 ], # X
    [ 0x07, 0x08, 0x70, 0x08, 0x07 ], # Y
    [ 0x61, 0x51, 0x49, 0x45, 0x43 ], # Z
    [ 0x00, 0x7F, 0x41, 0x41, 0x00 ], # [
    [ 0x02, 0x04, 0x08, 0x10, 0x20 ], # \
    [ 0x00, 0x41, 0x41, 0x7F, 0x00 ], # ]
    [ 0x04, 0x02, 0x01, 0x02, 0x04 ], # ^
    [ 0x40, 0x40, 0x40, 0x40, 0x40 ], # _
    [ 0x00, 0x03, 0x02, 0x04, 0x00 ], # ' 
    [ 0x20, 0x54, 0x54, 0x54, 0x78 ], # a
    [ 0x7F, 0x48, 0x44, 0x44, 0x38 ], # b
    [ 0x38, 0x44, 0x44, 0x44, 0x20 ], # c
    [ 0x38, 0x44, 0x44, 0x48, 0x7F ], # d
    [ 0x38, 0x54, 0x54, 0x54, 0x18 ], # e
    [ 0x08, 0x7E, 0x09, 0x01, 0x02 ], # f
    [ 0x18, 0xA4, 0xA4, 0xA4, 0x7C ], # g
    [ 0x7F, 0x08, 0x04, 0x04, 0x78 ], # h
    [ 0x00, 0x44, 0x7D, 0x40, 0x00 ], # i
    [ 0x40, 0x80, 0x84, 0x7D, 0x00 ], # j
    [ 0x7F, 0x10, 0x28, 0x44, 0x00 ], # k
    [ 0x00, 0x41, 0x7F, 0x40, 0x00 ], # l
    [ 0x7C, 0x04, 0x18, 0x04, 0x78 ], # m
    [ 0x7C, 0x08, 0x04, 0x04, 0x78 ], # n
    [ 0x38, 0x44, 0x44, 0x44, 0x38 ], # o
    [ 0xFC, 0x24, 0x24, 0x24, 0x18 ], # p
    [ 0x18, 0x24, 0x24, 0x18, 0xFC ], # q
    [ 0x7C, 0x08, 0x04, 0x04, 0x08 ], # r
    [ 0x48, 0x54, 0x54, 0x54, 0x20 ], # s
    [ 0x04, 0x3F, 0x44, 0x40, 0x20 ], # t
    [ 0x3C, 0x40, 0x40, 0x20, 0x7C ], # u
    [ 0x1C, 0x20, 0x40, 0x20, 0x1C ], # v
    [ 0x3C, 0x40, 0x30, 0x40, 0x3C ], # w
    [ 0x44, 0x28, 0x10, 0x28, 0x44 ], # x
    [ 0x1C, 0xA0, 0xA0, 0xA0, 0x7C ], # y
    [ 0x44, 0x64, 0x54, 0x4C, 0x44 ], # z
    [ 0x00, 0x08, 0x36, 0x41, 0x00 ], # {
    [ 0x00, 0x00, 0x77, 0x00, 0x00 ], # |
    [ 0x00, 0x41, 0x36, 0x08, 0x00 ], # }
    [ 0x02, 0x01, 0x02, 0x04, 0x02 ], # ~
    [ 0x55, 0x00, 0x55, 0x00, 0x55 ]
]

_fontsize=5;

class SSD1331:

    _INIT = (
        (_DISPLAYOFF, b''),
        (_LOCK, b'\x0b'),
        (_SETREMAP, b'\x72'), # RGB Color
        (_STARTLINE, b'\x00'),
        (_DISPLAYOFFSET, b'\x00'),
        (_NORMALDISPLAY, b''),
        (_PHASEPERIOD, b'\x31'),
        (_SETMULTIPLEX, b'\x3f'),
        (_SETMASTER, b'\x8e'),
        (_POWERMODE,b'\x0b'),
        (_PRECHARGE, b'\x31'), #;//0x1F - 0x31
        (_CLOCKDIV, b'\xf0'),
        (_VCOMH, b'\x3e'), #;//0x3E - 0x3F
        (_MASTERCURRENT, b'\x0c'), # ;//0x06 - 0x0F
        (_PRECHARGEA, b'\x64'),
        (_PRECHARGEB, b'\x78'),
        (_PRECHARGEC, b'\x64'),
        (_PRECHARGELEVEL, b'\x3a'), # 0x3A - 0x00
        (_CONTRASTA, b'\x91'), #//0xEF - 0x91
        (_CONTRASTB, b'\x50'), #;//0x11 - 0x50
        (_CONTRASTC, b'\x7d'), #;//0x48 - 0x7D
        (_NO_SCROLL, b''),
        (_DISPLAYON, b'')
    )
    _ENCODE_PIXEL = ">H"
    _ENCODE_POS = ">BB"
    _ENCODE_LINE = ">BBBBBBB"
    _ENCODE_RECT = ">BBBBBBBBBB"

    def line(self,x1,y1,x2,y2,color):
        r= (color >> 10) & 0x3e
        g= (color >> 5) & 0x3e
        b= (color & 0x1f) << 1
        data =ustruct.pack(self._ENCODE_LINE,x1,y1,x2,y2,r,g,b)
        self._write(_DRAWLINE,data)

    def rectangle(self,x,y,width,height,linecolor,fillcolor):
        if fillcolor is None:
          self._write(_FILL,b'\x00')
          br = 0
          bg = 0
          bb = 0
        else:
          self._write(_FILL,b'\x01')
          br= (fillcolor >> 10) & 0x3e
          bg= (fillcolor >> 5) & 0x3e
          bb= (fillcolor & 0x1f) << 1
        r= (linecolor >> 10) & 0x3e
        g= (linecolor >> 5) & 0x3e
        b= (linecolor & 0x1f) << 1
        data = ustruct.pack(self._ENCODE_RECT,x,y,x+width-1,y+height-1,r,g,b,br,bg,bb)
        self._write(_DRAWRECT,data)


    def fill(self,color=0):
        self.rectangle(0,0,self.width,self.height,color,color)


    def __init__(self, spi, dc, cs, rst=None, width=96, height=64):
        self.spi=spi
        self.dc = dc
        self.cs = cs
        self.rst = rst
        self.width = width
        self.height = height
        self.reset()
        for command,data in self._INIT:
           self._write(command,data)
        self.font = None

    def _write(self, command=None, data=None):
        if command is None:
            self.dc.value(1)
        else:
            self.dc.value(0)
        self.cs.value(0)
        if command is not None:
            self.spi.write(bytearray([command]))
        if data is not None:
            self.spi.write(data)
        self.cs.value(1)


    def _read(self, command=None, count=0):
        self.dc.value(0)
        self.cs.value(0)
        if command is not None:
            self.spi.write(bytearray([command]))
        if count:
            data = self.spi.read(count)
        self.cs.value(1)
        return data


    def color565(self,r, g, b):
        #  5  4  3  2  1  0  9  8  7  6  5  4  3  2  1  0
        #  R4 R3 R2 R1 R0 G5 G4 G3 G2 G1 G0 B4 B3 B2 B1 B0
        # return  (r & 0xf8) << 8 | (g & 0xfc) << 3 | b >> 3
        
        #  for ARM need  to swap byte
        #  G2 G1 G0 B4 B3 B2 B1 B0 R4 R3 R2 R1 R0 G5 G4 G3
        return  (g & 0x1C) << 1 | (b >> 3) | (r & 0xf8) | g >> 5


    def pixel(self, x , y , color=None):
        """ set pixel position """
        self._write(_SETCOLUMN,bytearray([x,x]))
        self._write(_SETROW,bytearray([y,y]))

        if color is None:
          """ read pixel """
          return self._read(None,2)
        else:
#          self._write(None,bytearray([color >> 8, color &0xff]))
          self.line(x,y,x,y,color)

    def block(self, x,y,width,height, data):
        self._write(_SETCOLUMN, bytearray([x,x+width-1]))
        self._write(_SETROW,bytearray([y,y+height-1]))
        self._write(None,data)

    def reset(self):
      if self.rst is not None:
         self.rst.value(0)
         utime.sleep(0.1)
         self.rst.value(1)

    def setFont(self,font):
        _fontsize = 5; #to set font size here

    def putText(self,x,y,txt,color):
        for c in txt:
         print(x,y,c)
         x = self.putChar(x,y,c,color)
          
    def putChar(self, x, y, ch, c):
        for i in range(0, 5, 1):
            line = ascii[ord(ch) & 0x7F][i]
            for j in range(0, 8, 1):
                if line & 0x1:
                    self.pixel(x + i, y + j, c)
                line >>= 1
        return x+_fontsize
    
if __name__ == "__main__":
    from machine import Pin, SPI
    spi = SPI(0,baudrate=10000000,sck=Pin(6),mosi=Pin(7))
    dc=Pin(8,Pin.OUT)
    cs=Pin(9,Pin.OUT)
    oled = SSD1331(spi=spi,dc=Pin(8),cs=Pin(9))
    oled.fill(0)

    import framebuf
    buffer = bytearray(oled.width * oled.height * 2)
    fb = framebuf.FrameBuffer(buffer,
                              oled.width,
                              oled.height,
                              framebuf.RGB565)

    #test frame buffer
    colors = []
    for i in range(8):
        r = (i & 1) * 255
        g = ((i >> 1)  & 1)  * 255
        b = ((i >> 2) & 1 ) * 255
        colors.append(oled.color565(r,g,b))
            
    while True:
        for color in colors:
            fb.fill(color)
            oled.block(0,0,96,64,buffer)
            utime.sleep(1)